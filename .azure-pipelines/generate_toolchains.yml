parameters:
- name: bazeliskInstallCommandPrefix
  displayName: "Bazelisk Install Command Prefix"
  type: string
  default: "sudo"
- name: bazeliskInstallPath
  displayName: "Bazelisk Install Path"
  type: string
  default: "/usr/local/bin/bazel"
- name: bazeliskReleaseFilename
  displayName: "Bazelisk Relase Filename"
  type: string
  default: bazelisk-linux-amd64
- name: osFamily
  displayName: "OS Family"
  type: string
  default: "linux"
- name: gcrImageName
  displayName: "GCR Image Name"
  type: string
  default: "envoy-build"

steps:
- bash: |
    rm -rf /c/Windows/System32/bash.exe
  condition: eq(variables['Agent.OS'], 'Windows_NT')
- bash: |
    ${{  parameters.bazeliskInstallCommandPrefix  }} curl -sSL -o ${{  parameters.bazeliskInstallPath  }} https://github.com/bazelbuild/bazelisk/releases/download/v1.4.0/${{  parameters.bazeliskReleaseFilename  }}
    ${{  parameters.bazeliskInstallCommandPrefix  }} chmod +x ${{  parameters.bazeliskInstallPath  }}
  displayName: Install Bazelisk
- task: GoTool@0
  inputs:
    version: '1.16'
- bash: |
    toolchains/regenerate.sh
  env:
    COMMIT_TOOLCHAINS: "true"
    GCR_IMAGE_NAME: ${{  parameters.gcrImageName }}
    OS_FAMILY: ${{  parameters.osFamily  }}
    SOURCE_BRANCH: $(Build.SourceBranch)
  displayName: Generate toolchains
