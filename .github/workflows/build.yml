name: Envoy/build-tools

permissions:
  contents: read

on:
  push:
    branches:
    - main
  pull_request:


jobs:
  detect-changes:
    runs-on: ubuntu-latest
    if: >-
      ${{
          github.repository == 'envoyproxy/envoy-build-tools'
          || vars.ENVOY_CI_RUN == 'true'
      }}
    outputs:
      debian: ${{ steps.filter.outputs.debian }}
      ubuntu: ${{ steps.filter.outputs.ubuntu }}
      shared: ${{ steps.filter.outputs.shared }}
    steps:
      - uses: actions/checkout@v5
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            debian:
              - 'docker/linux/debian/**'
              - 'docker/linux/debian_build.sh'
            ubuntu:
              - 'docker/linux/ubuntu/**'
            shared:
              - 'docker/push.sh'
              - 'docker/linux/build.sh'
              - 'docker/linux/common_fun.sh'
              - 'docker/linux/group_manifests.sh'
              - '.github/workflows/**'

  build_image:
    needs: detect-changes
    if: >-
      ${{
          (github.repository == 'envoyproxy/envoy-build-tools'
          || vars.ENVOY_CI_RUN == 'true')
          && (
            github.event_name == 'push'
            || needs.detect-changes.outputs.shared == 'true'
            || (matrix.target == 'debian' && needs.detect-changes.outputs.debian == 'true')
            || (matrix.target == 'ubuntu' && needs.detect-changes.outputs.ubuntu == 'true')
          )
      }}
    strategy:
      fail-fast: false
      matrix:
        target: [ubuntu, debian]
        arch: [amd64, arm64]
    name: Build (${{ matrix.target }}-${{ matrix.arch }})
    uses: ./.github/workflows/_build_image.yml
    with:
      distro: ${{ matrix.target }}
      os_family: ${{ matrix.os_family != '' && matrix.os_family || 'linux' }}
      host-platform: ${{ matrix.arch }}
      runs-on: ${{ matrix.arch == 'amd64' && 'ubuntu-22.04' || 'ubuntu-22.04-arm' }}
      target-platforms: ${{ matrix.arch == 'amd64' && 'linux/amd64' || 'linux/arm64' }}

  push-manifests:
    name: Create manifests (${{ github.event_name == 'pull_request' && 'dry run' || 'push' }})
    runs-on: ubuntu-latest
    needs: [detect-changes, build_image]
    if: always() && needs.build_image.result != 'cancelled' && needs.build_image.result != 'failure'
    permissions:
      contents: read
      packages: write
    steps:
    - uses: envoyproxy/toolshed/gh-actions/bind-mounts@actions-v0.3.28
      with:
        mounts: |
          - src: /mnt/workspace
            target: ${{ github.workspace }}
            chown: "runner:runner"
          - src: /mnt/oci
            target: /tmp/oci
            chown: "runner:runner"
    - name: 'Checkout repository'
      uses: actions/checkout@v5
    - name: Get docker SHA
      id: docker-sha
      shell: bash
      run: |
        TAG_SHA=$(git log -1 --pretty=format:"%H" ./docker)
        echo "sha=${TAG_SHA}" >> $GITHUB_OUTPUT
    - name: Determine which distros were built
      id: built-distros
      shell: bash
      run: |
        # On push to main, always include both
        if [ "${{ github.event_name }}" = "push" ]; then
          echo "include-debian=true" >> $GITHUB_OUTPUT
          echo "include-ubuntu=true" >> $GITHUB_OUTPUT
        else
          # On PR, check what changed
          INCLUDE_DEBIAN="false"
          INCLUDE_UBUNTU="false"

          # If shared files changed, include both
          if [ "${{ needs.detect-changes.outputs.shared }}" = "true" ]; then
            INCLUDE_DEBIAN="true"
            INCLUDE_UBUNTU="true"
          else
            # Otherwise include based on specific changes
            if [ "${{ needs.detect-changes.outputs.debian }}" = "true" ]; then
              INCLUDE_DEBIAN="true"
            fi
            if [ "${{ needs.detect-changes.outputs.ubuntu }}" = "true" ]; then
              INCLUDE_UBUNTU="true"
            fi
          fi

          echo "include-debian=${INCLUDE_DEBIAN}" >> $GITHUB_OUTPUT
          echo "include-ubuntu=${INCLUDE_UBUNTU}" >> $GITHUB_OUTPUT
        fi
    - name: Generate manifest configuration (Debian)
      if: steps.built-distros.outputs.include-debian == 'true'
      id: config-debian
      uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.3.26
      with:
        input-format: yaml
        filter: >-
          {manifests: .}
        input: |
          ## debian
          # devtools
          - name: envoy-build
            tag: devtools-${{ steps.docker-sha.outputs.sha }}
            registry: docker.io/envoyproxy
            architectures:
            - amd64
            - arm64
            artifact-pattern: oci-debian-{arch}/debian-devtools-${{ steps.docker-sha.outputs.sha }}-{arch}.tar
          # ci
          - name: envoy-build
            tag: ci-${{ steps.docker-sha.outputs.sha }}
            registry: docker.io/envoyproxy
            architectures:
            - amd64
            - arm64
            artifact-pattern: oci-debian-{arch}/debian-ci-${{ steps.docker-sha.outputs.sha }}-{arch}.tar
          # worker
          - name: envoy-build
            tag: worker-${{ steps.docker-sha.outputs.sha }}
            registry: docker.io/envoyproxy
            architectures:
            - amd64
            - arm64
            artifact-pattern: oci-debian-{arch}/debian-worker-${{ steps.docker-sha.outputs.sha }}-{arch}.tar
          # worker (gcr)
          - name: envoy-build
            tag: worker-${{ steps.docker-sha.outputs.sha }}
            registry: gcr.io/envoy-ci
            architectures:
            - amd64
            - arm64
            artifact-pattern: oci-debian-{arch}/debian-worker-${{ steps.docker-sha.outputs.sha }}-{arch}.tar
          # gcc
          - name: envoy-build
            tag: gcc-${{ steps.docker-sha.outputs.sha }}
            registry: docker.io/envoyproxy
            architectures:
            - amd64
            - arm64
            artifact-pattern: oci-debian-{arch}/debian-gcc-${{ steps.docker-sha.outputs.sha }}-{arch}.tar
          # gcc (gcr)
          - name: envoy-build
            tag: gcc-${{ steps.docker-sha.outputs.sha }}
            registry: gcr.io/envoy-ci
            architectures:
            - amd64
            - arm64
            artifact-pattern: oci-debian-{arch}/debian-gcc-${{ steps.docker-sha.outputs.sha }}-{arch}.tar
          # docker
          - name: envoy-build
            tag: docker-${{ steps.docker-sha.outputs.sha }}
            registry: docker.io/envoyproxy
            architectures:
            - amd64
            - arm64
            artifact-pattern: oci-debian-{arch}/debian-docker-${{ steps.docker-sha.outputs.sha }}-{arch}.tar
          # test
          - name: envoy-build
            tag: test-${{ steps.docker-sha.outputs.sha }}
            registry: docker.io/envoyproxy
            architectures:
            - amd64
            - arm64
            artifact-pattern: oci-debian-{arch}/debian-test-${{ steps.docker-sha.outputs.sha }}-{arch}.tar
          # llvm
          - name: envoy-build
            tag: llvm-${{ steps.docker-sha.outputs.sha }}
            registry: docker.io/envoyproxy
            architectures:
            - amd64
            artifact-pattern: oci-debian-{arch}/debian-llvm-${{ steps.docker-sha.outputs.sha }}-{arch}.tar
          # mobile
          - name: envoy-build
            tag: mobile-${{ steps.docker-sha.outputs.sha }}
            registry: docker.io/envoyproxy
            architectures:
            - amd64
            artifact-pattern: oci-debian-{arch}/debian-mobile-${{ steps.docker-sha.outputs.sha }}-{arch}.tar
    - name: Generate manifest configuration (Ubuntu)
      if: steps.built-distros.outputs.include-ubuntu == 'true'
      id: config-ubuntu
      uses: envoyproxy/toolshed/gh-actions/jq@actions-v0.3.26
      with:
        input-format: yaml
        filter: >-
          {manifests: .}
        input: |
          ## ubuntu
          # ci
          - name: envoy-build-ubuntu
            tag: ci-${{ steps.docker-sha.outputs.sha }}
            registry: docker.io/envoyproxy
            architectures:
            - arm64
            - amd64
            artifact-pattern: oci-ubuntu-{arch}/ubuntu-ci-${{ steps.docker-sha.outputs.sha }}-{arch}.tar
          # mobile
          - name: envoy-build-ubuntu
            tag: mobile-${{ steps.docker-sha.outputs.sha }}
            registry: docker.io/envoyproxy
            architectures:
            - amd64
            artifact-pattern: oci-ubuntu-{arch}/ubuntu-mobile-${{ steps.docker-sha.outputs.sha }}-{arch}.tar
          # test
          - name: envoy-build-ubuntu
            tag: test-${{ steps.docker-sha.outputs.sha }}
            registry: docker.io/envoyproxy
            architectures:
            - amd64
            artifact-pattern: oci-ubuntu-{arch}/ubuntu-test-${{ steps.docker-sha.outputs.sha }}-{arch}.tar
          # full
          - name: envoy-build-ubuntu
            tag: full-f8d1fd9bdac3a7843d1e69816456648989d238be
            registry: docker.io/envoyproxy
            architectures:
            - amd64
            - arm64
            artifact-pattern: oci-ubuntu-{arch}/ubuntu-full-${{ steps.docker-sha.outputs.sha }}-{arch}.tar
            additional-tags:
            - ${{ steps.docker-sha.outputs.sha }}
          # full (gcr)
          - name: envoy-build
            tag: ${{ steps.docker-sha.outputs.sha }}
            registry: gcr.io/envoy-ci
            architectures:
            - amd64
            - arm64
            artifact-pattern: oci-ubuntu-{arch}/ubuntu-full-${{ steps.docker-sha.outputs.sha }}-{arch}.tar
    - name: Merge manifest configurations
      id: config
      shell: bash
      run: |
        DEBIAN_CONFIG='${{ steps.config-debian.outputs.value }}'
        UBUNTU_CONFIG='${{ steps.config-ubuntu.outputs.value }}'

        # Combine the configs
        if [ "${{ steps.built-distros.outputs.include-debian }}" = "true" ] && [ "${{ steps.built-distros.outputs.include-ubuntu }}" = "true" ]; then
          # Both configs present, merge them
          MERGED=$(echo "$DEBIAN_CONFIG" "$UBUNTU_CONFIG" | jq -s '{"manifests": (.[0].manifests + .[1].manifests)}')
        elif [ "${{ steps.built-distros.outputs.include-debian }}" = "true" ]; then
          # Only Debian
          MERGED="$DEBIAN_CONFIG"
        elif [ "${{ steps.built-distros.outputs.include-ubuntu }}" = "true" ]; then
          # Only Ubuntu
          MERGED="$UBUNTU_CONFIG"
        else
          # Neither (shouldn't happen, but handle it)
          MERGED='{"manifests": []}'
        fi

        # Output the merged config
        echo "value<<EOF" >> $GITHUB_OUTPUT
        echo "$MERGED" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    - name: Collect and push OCI artifacts
      uses: envoyproxy/toolshed/gh-actions/oci/collector@actions-v0.3.26
      with:
        manifest-config: ${{ steps.config.outputs.value }}
        dry-run: ${{ github.event_name == 'pull_request' }}
        dockerhub-username: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && secrets.DOCKERHUB_USERNAME || '' }}
        dockerhub-password: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && secrets.DOCKERHUB_PASSWORD || '' }}
        gcr-key: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && secrets.GCP_SERVICE_ACCOUNT_KEY || '' }}
